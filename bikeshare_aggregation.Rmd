---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 
```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(rgdal, sp, data.table,lubridate,dplyr,stringr,ggplot2)

```

```{r}

library(scales)
dt <- fread('data/bikes_preprocessed_cleaned.csv')

# drop dupes cols
df<- dt[, which(duplicated(names(dt))) := NULL]
df$timestamp<- ymd_hms(df$timestamp)
df$end_timestamp<- ymd_hms(df$end_timestamp)


transpose.datetime <- function(bikeId){
  df.test <- df %>% filter(bikeId==bikeId)

min(df.test$timestamp)

datetime.index <-seq(from = ISOdatetime(2019,04,03,09,0,0),to=ISOdatetime(2019,07,11,9,0,0), by = "10 min") %>% as.data.frame()
colnames(datetime.index)<-c('dt.index')

setDT(df.test)
setDT(datetime.index)

setkey(df.test,  timestamp)[, dateMatch:=timestamp]
merged <-df.test[datetime.index, roll='nearest']

return (merged)
}


# select a bike ID to plot the trip
merged <- transpose.datetime(13001)

if(!require("osmdata")) install.packages("osmdata")


library(ggmap)
mad_map <- get_map(getbb("Berlin"),maptype = 'terrain',source='osm')

#final map
p <- ggmap(mad_map)+ geom_point(data=merged %>% filter(date_only=='2019-07-02'),aes(bike_exact_longitude,bike_exact_latitude,color=(timestamp)),size=.2)+scale_color_gradient(high="red",low="blue",name = "Hour",trans = time_trans()) +geom_path(data=merged %>% filter(date_only=='2019-07-02'),aes(bike_exact_longitude,bike_exact_latitude,color=(timestamp)),size=0.1)+scale_color_gradient(high="red",low="blue",name = "Hour",trans = time_trans())
p
```
## aggregate per LOR,Ortsteil, mode, 
```{r}
df <- fread('data/bikes_preprocessed_cleaned.csv')

groupy <- df %>% group_by(date_only,from_spatial_na,from_district_spatial_na,to_spatial_na,to_district_spatial_na,mode,hour_of_day,week.day.label) %>% summarise(total_counts=n(), median.duration=median(duration_minutes),median.speed=median(speed))

df<-NULL

# load geo data from LOR 
df.lor <- fread('data/lor_geodata.csv') %>% select(-V1,-spatial_al,-BZRNAME,-PGRNAME) 
df.lor.from <- df.lor
colnames(df.lor.from)<- paste0('LOR_from_',colnames(df.lor.from))

df.lor.to <- df.lor
colnames(df.lor.to)<- paste0('LOR_to_',colnames(df.lor.to))


# load geo data from LOR districts
df.districts <- fread('data/lor_districts_geodata.csv') %>% select(-V1,-spatial_al)

df.districts.from <- df.districts
colnames(df.districts.from)<- paste0('district_from_',colnames(df.districts.from))

df.districts.to <- df.districts
colnames(df.districts.to)<- paste0('district_to_',colnames(df.districts.to))

#add from LOR & dictrict Names and Centroids :
merged <- merge(groupy,df.districts.from,by.x='from_district_spatial_na',by.y='district_from_spatial_na')
merged <- merge(merged,df.districts.to,by.x='to_district_spatial_na',by.y='district_to_spatial_na')

merged <- merge(merged,df.lor.from,by.x='from_spatial_na',by.y='LOR_from_spatial_na')
merged <- merge(merged,df.lor.to,by.x='to_spatial_na',by.y='LOR_to_spatial_na')

fwrite(merged,'data/bikes_lor_and_districs_aggregated.csv')
```


# aggregate per districs and hour of day
```{r}
df <- fread('data/bikes_preprocessed_cleaned.csv') %>% filter(mode=='trip')

groupy <- df %>% group_by(from_district_spatial_na,to_district_spatial_na,mode,hour_of_day,is.weekend) %>% summarise(total_counts=n())

df<-NULL


# load geo data from LOR districts
df.districts <- fread('data/lor_districts_geodata.csv') %>% select(-V1,-spatial_al)

df.districts.from <- df.districts
colnames(df.districts.from)<- paste0('district_from_',colnames(df.districts.from))

df.districts.to <- df.districts
colnames(df.districts.to)<- paste0('district_to_',colnames(df.districts.to))

#add from LOR & dictrict Names and Centroids :
merged <- merge(groupy,df.districts.from,by.x='from_district_spatial_na',by.y='district_from_spatial_na')
merged <- merge(merged,df.districts.to,by.x='to_district_spatial_na',by.y='district_to_spatial_na')


fwrite(merged,'data/trips_districs_hour_weekend_aggregated.csv')
```

